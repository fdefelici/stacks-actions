name: "Generate Configuration Documentation"
description: "Generate and upload Stacks Core configuration documentation"
branding:
  icon: "file-text"
  color: "blue"

inputs:
  output:
    description: "Output file for generated documentation"
    required: false
    default: "./node-parameters.md"
  min-doc-size:
    description: "Minimum documentation size in bytes"
    required: false
    default: "50000"
  rust-nightly-version:
    description: "Specific nightly version to use (e.g., 'nightly-2025-06-17')"
    required: false
    default: "nightly-2025-06-17"
  retention-days:
    description: "Number of days to retain the artifact"
    required: false
    default: "90"

runs:
  using: "composite"
  steps:
    ## Checkout the code
    - name: Checkout the latest code
      id: git_checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    ## Install Rust nightly toolchain (required for rustdoc JSON output)
    - name: Install Rust nightly toolchain
      id: install_rust
      uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1.13.0
      with:
        toolchain: ${{ inputs.rust-nightly-version }}
        components: rust-docs-json

    ## Generate configuration documentation
    - name: Generate Configuration Documentation
      id: generate_docs
      shell: bash
      env:
        OUTPUT_FILE: ${{ inputs.output }}
        PROJECT_ROOT: $(pwd)
      run: |
        echo "Generating configuration documentation..."

        # Navigate to the script directory and run
        bash contrib/tools/config-docs-generator/generate-config-docs.sh

        # Verify output was generated
        if [[ ! -f "$OUTPUT_FILE" ]]; then
          echo "Error: Configuration documentation was not generated"
          echo "Expected file: $OUTPUT_FILE"
          exit 1
        fi

        echo "Documentation generated successfully at $OUTPUT_FILE"

    ## Validate generated documentation quality
    - name: Validate Generated Documentation
      id: validate_docs
      shell: bash
      run: |
        echo "Validating generated documentation..."

        OUTPUT_FILE="${{ inputs.output }}"

        # Check if file exists and has content
        if [[ ! -f "$OUTPUT_FILE" ]]; then
          echo "Error: Markdown file not found at $OUTPUT_FILE"
          exit 1
        fi

        # Check file size (should be ~100kb as of 2025-07-25)
        FILE_SIZE=$(wc -c < "$OUTPUT_FILE")
        MIN_SIZE=${{ inputs.min-doc-size }}

        if [[ $FILE_SIZE -lt $MIN_SIZE ]]; then
          echo "Error: Generated documentation is too small ($FILE_SIZE bytes, minimum $MIN_SIZE)"
          echo "This likely indicates a generation failure"
          exit 1
        fi

        # Check word count and basic structure
        WORD_COUNT=$(wc -w < "$OUTPUT_FILE")
        LINE_COUNT=$(wc -l < "$OUTPUT_FILE")

        echo "Documentation validation results:"
        echo "  - File size: $FILE_SIZE bytes"
        echo "  - Word count: $WORD_COUNT words"
        echo "  - Line count: $LINE_COUNT lines"

        echo "Documentation validation completed successfully âœ…"

    ## Upload documentation as artifact
    - name: Upload Documentation Artifact
      id: upload_artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: node-parameters-bundle
        path: ${{ inputs.output }}
        retention-days: ${{ inputs.retention-days }}
        if-no-files-found: error

    ## Generate job summary
    - name: Generate Job Summary
      id: summary
      shell: bash
      run: |
        echo "## Configuration Documentation Generated âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Stacks Core configuration documentation has been successfully generated and uploaded." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Add file statistics if available
        OUTPUT_FILE="${{ inputs.output }}"
        if [[ -f "$OUTPUT_FILE" ]]; then
          FILE_SIZE=$(wc -c < "$OUTPUT_FILE")
          WORD_COUNT=$(wc -w < "$OUTPUT_FILE")

          echo "### ðŸ“Š Generation Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: $(numfmt --to=iec-i --suffix=B $FILE_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Word Count**: $WORD_COUNT words" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust Toolchain**: ${{ inputs.rust-nightly-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### ðŸ“„ Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ inputs.artifact-name }}\` - Complete configuration documentation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifact Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Name**: \`${{ inputs.artifact-name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Retention**: 30 days" >> $GITHUB_STEP_SUMMARY
        echo "- **Location**: Available in workflow run artifacts section" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> ðŸ’¡ **Tip**: Download the artifact to access the generated documentation files"
